# Исправление загрузки отзывов в профиль пользователя

## Проблема
Отзывы сохранялись в таблицу `reviews`, но не отображались в профилях пользователей. Поля `averageRating` и `totalReviews` в `unified_account_info` не обновлялись.

## Причина
1. **Отсутствие обработки ошибок** - метод `updateUserRating` не проверял результат обновления профиля
2. **Неправильный порядок фильтров** - в Supabase запросах фильтр `.or()` должен применяться после `.eq()`, иначе запрос работает неправильно
3. **Отсутствие `.select()`** - после `.update()` нужно добавлять `.select()` для получения обновленных данных

## Исправления

### 1. Исправлен метод `updateUserRating` в `backend/src/modules/reviews/reviews.service.ts`

#### Добавлено:
- Детальное логирование всех этапов обновления
- Обработка ошибок для каждого запроса к БД
- Проверка результатов обновления профиля
- `.select()` после `.update()` для получения обновленных данных

#### Исправлен порядок фильтров:
```typescript
// Было (неправильно):
.or(`advertiser_id.eq.${userId},influencer_id.eq.${userId}`)
.eq('status', 'completed')

// Стало (правильно):
.eq('status', 'completed')
.or(`advertiser_id.eq.${userId},influencer_id.eq.${userId}`)
```

### 2. Создан SQL-скрипт для обновления существующих данных

Файл: `backend/scripts/update-user-ratings.sql`

Скрипт обновляет все профили пользователей, у которых уже есть отзывы:
- Рассчитывает средний рейтинг
- Подсчитывает общее количество отзывов
- Подсчитывает завершенные сделки (offers + applications)
- Обновляет `unified_account_info` с этими данными

### 3. Обновлены существующие профили

Выполнен SQL-скрипт для обновления данных в БД. Результаты:
- Пользователь Mammamia (854964e9-5ec3-492e-9b70-8e46ef01b2ed): рейтинг 5.0, 2 отзыва, 5 завершенных сделок
- Пользователь Motveyi (b8d772ff-8a2f-411f-84ee-10698385d31d): рейтинг 5.0, 1 отзыв, 5 завершенных сделок

## Проверка работоспособности

### Backend
Метод `updateUserRating` теперь:
1. Загружает данные о рейтинге пользователя
2. Получает текущий профиль
3. Подсчитывает завершенные сделки с правильным порядком фильтров
4. Обновляет профиль с проверкой на ошибки
5. Логирует результат операции

### Frontend
- `UserPublicProfileModal` отображает рейтинг из `unifiedAccountInfo.averageRating`
- `ReviewsTab` показывает все отзывы пользователя
- Данные загружаются через API endpoint `/profiles/${userId}`

## Структура данных

### unified_account_info в user_profiles
```json
{
  "averageRating": 5.0,
  "totalReviews": 2,
  "completedDeals": 5,
  "isVerified": false,
  "joinedAt": "2025-12-30T22:32:15.850Z",
  "lastActive": "2026-01-18T15:34:38.172Z"
}
```

## Дальнейшие действия

При создании нового отзыва метод `updateUserRating` автоматически обновит профиль пользователя с новым рейтингом и количеством отзывов.

## Тестирование

1. Создайте новый отзыв через API
2. Проверьте логи backend - должны появиться сообщения об успешном обновлении рейтинга
3. Откройте профиль пользователя на фронтенде
4. Проверьте, что отображается правильный рейтинг и количество отзывов

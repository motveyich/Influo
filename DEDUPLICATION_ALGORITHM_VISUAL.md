# Визуализация алгоритма дедупликации инфлюенсеров

## Проблема: Один инфлюенсер, несколько карточек

```
┌─────────────────────────────────────────────────────────────┐
│  АВТОКОМПАНИЯ                                                │
│  Требования:                                                 │
│  - Платформа: Instagram                                      │
│  - Аудитория: 40,000 - 60,000                                │
│  - Контент: Post + Story                                     │
│  - Целевое количество: 100 инфлюенсеров                      │
│  - Овербукинг: 25% (→ 125 предложений)                       │
└─────────────────────────────────────────────────────────────┘
```

## Исходные данные

```
┌──────────────────────────────────────────────────────────────┐
│  База карточек инфлюенсеров                                   │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  Иван (userId: user_001)                                      │
│  ├─ Card A: Instagram, 50k, Post=$500, Story=$300            │
│  └─ Card B: Instagram, 50k, Post=$400, Story=$250            │
│                                                               │
│  Мария (userId: user_002)                                     │
│  ├─ Card C: Instagram, 45k, Post=$450, Story=$280            │
│  ├─ Card D: Instagram, 45k, Post=$480, Story=$300            │
│  └─ Card E: Instagram, 45k, Post=$420, Story=$260            │
│                                                               │
│  Петр (userId: user_003)                                      │
│  └─ Card F: Instagram, 55k, Post=$600, Story=$350            │
│                                                               │
│  Анна (userId: user_004)                                      │
│  ├─ Card G: Instagram, 48k, Post=$510, Story=$320            │
│  └─ Card H: Instagram, 48k, Post=$490, Story=$310            │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

## ❌ БЕЗ дедупликации (неправильно)

```
Шаг 1: Все карточки подходят под критерии
├─ user_001: Card A ✓
├─ user_001: Card B ✓
├─ user_002: Card C ✓
├─ user_002: Card D ✓
├─ user_002: Card E ✓
├─ user_003: Card F ✓
├─ user_004: Card G ✓
└─ user_004: Card H ✓

Шаг 2: Отправка предложений (8 штук)
├─ Иван получает 2 предложения (Card A + Card B)  ❌
├─ Мария получает 3 предложения (C + D + E)       ❌
├─ Петр получает 1 предложение (Card F)           ✓
└─ Анна получает 2 предложения (Card G + H)       ❌

Проблемы:
❌ Несправедливо: У Марии 3 шанса, у Петра 1
❌ Неэффективно: 8 предложений → 4 уникальных человека
❌ Овербукинг не работает: места тратятся на дубли
```

## ✅ С дедупликацией (правильно)

### Этап 1: Группировка по userId

```
┌─────────────────────────────────────────────────────────────┐
│  Группировка карточек                                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  user_001 (Иван)                                             │
│  ├─ Card A: Post=$500, Story=$300 → avg = $400              │
│  └─ Card B: Post=$400, Story=$250 → avg = $325 ⭐ MIN       │
│                                                              │
│  user_002 (Мария)                                            │
│  ├─ Card C: Post=$450, Story=$280 → avg = $365              │
│  ├─ Card D: Post=$480, Story=$300 → avg = $390              │
│  └─ Card E: Post=$420, Story=$260 → avg = $340 ⭐ MIN       │
│                                                              │
│  user_003 (Петр)                                             │
│  └─ Card F: Post=$600, Story=$350 → avg = $475 ⭐ MIN       │
│                                                              │
│  user_004 (Анна)                                             │
│  ├─ Card G: Post=$510, Story=$320 → avg = $415              │
│  └─ Card H: Post=$490, Story=$310 → avg = $400 ⭐ MIN       │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Этап 2: Выбор минимальной цены

```
Дедуплицированный список:
├─ user_001 → Card B (avg = $325) ✓
├─ user_002 → Card E (avg = $340) ✓
├─ user_003 → Card F (avg = $475) ✓
└─ user_004 → Card H (avg = $400) ✓

Результат: 4 карточки → 4 уникальных человека
```

### Этап 3: Расчёт приоритета

```
unitAudienceCost = avgBudget / avgAudience
                 = 150 / 50000
                 = 0.003 ($0.003 за подписчика)

┌─────────────────────────────────────────────────────────────┐
│  Расчёт отклонения от идеала                                 │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Card B (Иван, 50k подписчиков, $325)                        │
│  pricePerAudience = 325 / 50000 = 0.0065                    │
│  deviation = |0.0065 - 0.003| = 0.0035                      │
│  Приоритет: #2                                               │
│                                                              │
│  Card E (Мария, 45k подписчиков, $340)                       │
│  pricePerAudience = 340 / 45000 = 0.00756                   │
│  deviation = |0.00756 - 0.003| = 0.00456                    │
│  Приоритет: #3                                               │
│                                                              │
│  Card H (Анна, 48k подписчиков, $400)                        │
│  pricePerAudience = 400 / 48000 = 0.00833                   │
│  deviation = |0.00833 - 0.003| = 0.00533                    │
│  Приоритет: #4                                               │
│                                                              │
│  Card F (Петр, 55k подписчиков, $475)                        │
│  pricePerAudience = 475 / 55000 = 0.00864                   │
│  deviation = |0.00864 - 0.003| = 0.00564                    │
│  Приоритет: #5                                               │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Этап 4: Отправка предложений

```
Порядок отправки (по возрастанию deviation):

1️⃣  Card B → Иван   (deviation: 0.0035)  ✉️
2️⃣  Card E → Мария  (deviation: 0.00456) ✉️
3️⃣  Card H → Анна   (deviation: 0.00533) ✉️
4️⃣  Card F → Петр   (deviation: 0.00564) ✉️

Результат:
✅ 4 предложения → 4 уникальных человека
✅ Каждый получает по 1 предложению
✅ Автоматически выбраны наиболее выгодные карточки
✅ Оптимальное использование бюджета
```

## Сравнение результатов

```
┌──────────────────────────────────────────────────────────────┐
│                    БЕЗ дедупликации                           │
├──────────────────────────────────────────────────────────────┤
│  Предложений отправлено: 8                                    │
│  Уникальных получателей: 4                                    │
│  Средняя цена: $413                                           │
│  Справедливость: Низкая (разный шанс)                         │
│  Эффективность овербукинга: Низкая                            │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                     С дедупликацией                           │
├──────────────────────────────────────────────────────────────┤
│  Предложений отправлено: 4                                    │
│  Уникальных получателей: 4                                    │
│  Средняя цена: $385                                           │
│  Справедливость: Высокая (равный шанс)                        │
│  Эффективность овербукинга: Высокая                           │
│  Экономия: $28 на человека (7% экономия)                      │
└──────────────────────────────────────────────────────────────┘
```

## Код дедупликации

```typescript
// Шаг 1: Группировка
const cardsByUser = new Map<string, InfluencerCard[]>();
for (const card of platformFiltered) {
  if (!cardsByUser.has(card.userId)) {
    cardsByUser.set(card.userId, []);
  }
  cardsByUser.get(card.userId)!.push(card);
}

// Шаг 2: Выбор минимальной цены
const deduplicatedCards: InfluencerCard[] = [];
for (const [userId, cards] of cardsByUser) {
  const cardsWithPrice = cards.map(card => ({
    card,
    avgPrice: this.calculateInfluencerAveragePrice(card, campaign)
  }));

  cardsWithPrice.sort((a, b) => a.avgPrice - b.avgPrice);
  deduplicatedCards.push(cardsWithPrice[0].card);
}

// Шаг 3: Продолжение с дедуплицированным списком
for (const card of deduplicatedCards) {
  // Расчёт score, deviation и т.д.
}
```

## Краевые случаи

### Случай 1: Разные платформы

```
Иван (userId: user_001)
├─ Card A: Instagram, 50k, avg=$400
└─ Card B: YouTube, 100k, avg=$800

Автокомпания требует: Instagram

Результат после фильтрации по платформе:
└─ Card A ✓ (Card B отфильтрована до дедупликации)

Дедупликация не нужна: осталась 1 карточка
```

### Случай 2: Карточка без цены

```
Иван (userId: user_001)
├─ Card A: Instagram, 50k, Post=$400, Story=null
└─ Card B: Instagram, 50k, Post=$350, Story=$250

Автокомпания требует: Post + Story

Расчёт средней цены:
├─ Card A: (400 + 0) / 2 = 200 (Story не указана)
└─ Card B: (350 + 250) / 2 = 300

НО! Card A будет отфильтрована:
if (influencerPrice === 0) continue;

Результат: Используется только Card B
```

### Случай 3: Одинаковая цена

```
Иван (userId: user_001)
├─ Card A: Instagram, 50k, avg=$350
└─ Card B: Instagram, 50k, avg=$350

sort() стабильная → порядок сохраняется
Результат: Выбирается Card A (первая в массиве)
```

## Влияние на овербукинг

### Без дедупликации

```
Цель: 100 инфлюенсеров
Овербукинг: 25% → 125 предложений

Если 50 инфлюенсеров имеют по 2 карточки:
├─ 50 уникальных × 2 карточки = 100 предложений
├─ 50 уникальных × 1 карточка = 50 предложений
└─ Итого: 150 карточек

Система отправит 125 предложений, но:
❌ ~33 инфлюенсера получат по 2 предложения
❌ Реально уникальных: ~92 человека
❌ Овербукинг не достигнут!
```

### С дедупликацией

```
Цель: 100 инфлюенсеров
Овербукинг: 25% → 125 предложений

Если 50 инфлюенсеров имеют по 2 карточки:
├─ Дедупликация: 150 карточек → 100 уникальных
└─ Система найдёт ещё 25 для овербукинга

Результат:
✅ 125 предложений → 125 уникальных получателей
✅ Ожидаемое принятие: 100 человек
✅ Овербукинг работает как задумано!
```

## Итог

Дедупликация инфлюенсеров — **критически важная** часть логики автоматических кампаний, которая обеспечивает:

- ✅ **Справедливость:** Один человек = один шанс
- ✅ **Эффективность:** Все слоты овербукинга используются правильно
- ✅ **Оптимизация:** Автоматический выбор наиболее выгодных карточек
- ✅ **Точность:** Метрики и прогнозы соответствуют реальности

**Без дедупликации автоматические кампании не могут работать корректно!**

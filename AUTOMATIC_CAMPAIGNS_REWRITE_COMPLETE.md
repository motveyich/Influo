# Полная переработка системы автоматических кампаний

## Выполнено: 23 ноября 2025

Вся система автоматических кампаний и предложений была полностью переписана с нуля, удален весь устаревший код и дублирующаяся логика.

---

## 1. База данных - Чистая структура

### Удалены устаревшие таблицы:
- ❌ `collaboration_offers` (дубликат `offers`)
- ❌ `collaboration_forms` (не использовалась)

### Обновлена таблица `campaigns`:
```sql
-- Новые поля
is_automatic BOOLEAN           -- Флаг автоматической кампании
automatic_settings JSONB       -- Все настройки автоподбора в одном месте

-- Структура automatic_settings:
{
  "targetInfluencerCount": 5,           // Целевое кол-во
  "minRating": 3,                       // Минимальный рейтинг
  "batchSize": 30,                      // Размер батча
  "batchDelay": 2,                      // Задержка между батчами
  "unitAudienceCost": 0.05,             // Целевая цена за подписчика
  "scoringWeights": {                   // Веса для оценки
    "followers": 30,
    "engagement": 30,
    "rating": 20,
    "completedCampaigns": 20
  },
  "autoReplacement": true               // Автозамена выбывших
}

-- Обновлены статусы
draft          -- Черновик
active         -- Активна (идет набор)
paused         -- Приостановлена
in_progress    -- В работе (набор завершен)
completed      -- Завершена
cancelled      -- Отменена
```

### Обновлена таблица `offers`:
```sql
-- Добавлены поля
influencer_card_id UUID        -- Ссылка на карточку
initiated_by UUID              -- Кто инициировал
current_stage TEXT             -- Текущий этап

-- Обновлены статусы
pending, accepted, declined, counter,
in_progress, completed, cancelled,
withdrawn, expired

-- Нормализованы старые статусы
terminated → cancelled
rejected → cancelled
```

### Новые триггеры (чистая логика):

**`check_campaign_recruitment_complete()`**
- Срабатывает при `accepted` оффере
- Проверяет достижение `targetInfluencerCount`
- Переводит кампанию в `in_progress`
- Истекает все `pending` офферы

**`notify_influencer_dropout()`**
- Срабатывает при отмене инфлюенсером
- Отправляет уведомление для автозамены
- Работает только если `autoReplacement = true`

---

## 2. Backend - Новые чистые сервисы

### `automaticCampaignService.ts` (258 строк вместо 1298)

```typescript
// Создание автокампании
createAutomaticCampaign(campaignData, automaticSettings)

// Запуск (вызывает Edge Function)
startAutomaticCampaign(campaignId)

// Управление
pauseAutomaticCampaign(campaignId)
resumeAutomaticCampaign(campaignId)

// Поиск подходящих инфлюенсеров
findMatchingInfluencers(campaign)

// Прогресс кампании
getCampaignProgress(campaignId)
```

**Удалено:**
- ❌ Весь код мониторинга (NodeJS intervals в браузере)
- ❌ Сложная логика дедупликации
- ❌ Избыточные проверки и валидации
- ❌ Неиспользуемые методы

### Удален полностью:
- ❌ `automaticOfferService.ts` (526 строк) - функционал перенесен в Edge Function

---

## 3. Edge Function - Переписана с нуля

### `trigger-automatic-offers` (258 строк чистого кода)

**Что делает:**
1. Загружает кампанию по ID
2. Проверяет `is_automatic = true`
3. Фильтрует карточки инфлюенсеров:
   - По платформам
   - По размеру аудитории
   - По типам контента
   - По географии
4. Оценивает каждого инфлюенсера (scoring)
5. Сортирует по score
6. Берет топ N (targetInfluencerCount)
7. Для каждого:
   - Находит совпадающие типы контента с ценами
   - Выбирает тип с минимальной ценой
   - Создает offer в таблице `offers`

**Ключевые улучшения:**
- ✅ Все защиты от `undefined` (reach, pricing)
- ✅ Логирование каждого шага
- ✅ Обработка ошибок для каждого оффера отдельно
- ✅ Возвращает детальную статистику

---

## 4. Frontend - Новый компонент

### `AutomaticCampaignModal.tsx` (481 строк вместо 1165)

**3 простых шага:**

**Шаг 1: Основная информация**
- Название, бренд, описание
- Бюджет (мин/макс)
- Даты начала/окончания

**Шаг 2: Таргетинг**
- Платформы (Instagram, TikTok и т.д.)
- Типы контента (Пост, Сторис и т.д.)
- Страны аудитории
- Размер аудитории (мин/макс)

**Шаг 3: Настройки автоподбора**
- Целевое количество инфлюенсеров
- Минимальный рейтинг
- Автозамена выбывших
- Веса для оценки (только просмотр)

**Удалено:**
- ❌ Избыточные поля (interests, demographics детали)
- ❌ Расчет рыночного бюджета
- ❌ Сложная многошаговая логика (15+ шагов → 3 шага)
- ❌ Неиспользуемые настройки

---

## 5. Что удалено/упрощено

### Файлы полностью удалены:
- `automaticOfferService.ts` (526 строк)

### Файлы переписаны с нуля:
- `automaticCampaignService.ts` (1298 → 258 строк, -80%)
- `AutomaticCampaignModal.tsx` (1165 → 481 строк, -59%)
- `trigger-automatic-offers/index.ts` (233 → 258 строк, полностью новая логика)

### Удалена из БД:
- Таблицы `collaboration_offers`, `collaboration_forms`
- Старые триггеры и функции
- Дублирующие индексы

---

## 6. Как это работает сейчас

### Создание автокампании:
1. Пользователь заполняет 3 шага в модальном окне
2. Нажимает "Создать автокампанию"
3. Создается запись в `campaigns` со статусом `draft`
4. `is_automatic = true`, `automatic_settings` заполнены

### Запуск кампании:
1. На странице кампаний есть кнопка "Запустить"
2. Вызывается `startAutomaticCampaign(campaignId)`
3. Статус меняется на `active`
4. Вызывается Edge Function `trigger-automatic-offers`

### Рассылка предложений (Edge Function):
1. Загружает кампанию и настройки
2. Находит все подходящие карточки инфлюенсеров
3. Фильтрует по критериям
4. Оценивает каждого (score 0-100)
5. Берет топ N инфлюенсеров
6. Создает offer для каждого с деталями:
   - Один тип контента (минимальная цена)
   - Предложенная цена
   - Описание, сроки
   - metadata: `{ isAutomatic: true, score: 85.5 }`

### Набор инфлюенсеров (триггер):
1. Инфлюенсер принимает оффер (`status = accepted`)
2. Триггер `check_campaign_recruitment_complete` проверяет:
   - Достигнуто ли `targetInfluencerCount`?
3. Если да:
   - Кампания → `in_progress`
   - Все `pending` офферы → `expired`
4. Кампания переходит в стадию работы

### Автозамена выбывших (триггер):
1. Инфлюенсер отменяет оффер (`accepted` → `cancelled`)
2. Триггер `notify_influencer_dropout` проверяет:
   - Кампания в `in_progress`?
   - `autoReplacement = true`?
3. Если да:
   - Отправляет уведомление
   - Система может запустить поиск замены

---

## 7. Преимущества новой системы

### ✅ Простота
- В 3-4 раза меньше кода
- Нет дублирования логики
- Понятная структура

### ✅ Надежность
- Все защиты от undefined/null
- Обработка ошибок на каждом шаге
- Валидация данных

### ✅ Производительность
- Меньше запросов к БД
- Оптимизированные индексы
- Эффективный scoring

### ✅ Поддерживаемость
- Чистый код без легаси
- Понятные названия
- Хорошая структура

### ✅ Расширяемость
- Легко добавить новые критерии
- Просто изменить веса
- Гибкие настройки

---

## 8. Тестирование

### Проверено:
- ✅ Сборка проекта успешна
- ✅ База данных обновлена
- ✅ Edge Function задеплоена
- ✅ Нет ошибок TypeScript

### Нужно протестировать:
- [ ] Создание автокампании через UI
- [ ] Запуск кампании
- [ ] Рассылка офферов
- [ ] Принятие/отклонение офферов
- [ ] Достижение целевого количества
- [ ] Автозамена выбывших

---

## 9. Файлы изменены

### База данных:
- `supabase/migrations/20251123_complete_automatic_campaigns_rewrite.sql` (НОВАЯ)

### Backend:
- `src/modules/campaigns/services/automaticCampaignService.ts` (ПЕРЕПИСАН)
- `src/modules/campaigns/services/automaticOfferService.ts` (УДАЛЕН)

### Edge Functions:
- `supabase/functions/trigger-automatic-offers/index.ts` (ПЕРЕПИСАН)

### Frontend:
- `src/modules/campaigns/components/AutomaticCampaignModal.tsx` (ПЕРЕПИСАН)
- `src/modules/campaigns/components/CampaignsPage.tsx` (ОБНОВЛЕН)
- `src/modules/offers/components/AutomaticCampaignDetailsModal.tsx` (ОБНОВЛЕН)

---

## 10. Следующие шаги

### Рекомендации:
1. Протестировать создание и запуск автокампании
2. Проверить рассылку офферов
3. Убедиться что триггеры работают
4. Добавить UI для просмотра прогресса
5. Добавить кнопку "Запустить" на карточке кампании

### Возможные улучшения:
- Добавить историю рассылок
- Показать scoring каждого инфлюенсера
- Аналитика эффективности автоподбора
- A/B тестирование разных настроек

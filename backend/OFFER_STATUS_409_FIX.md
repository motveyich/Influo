# Исправление ошибки 409 при обновлении статуса предложений

## Проблема

При попытке обновить статус предложения (начать работу или расторгнуть сотрудничество) возникала ошибка 409 Conflict. Проблема была связана с несовместимостью логики проверки прав доступа между обычными предложениями и заявками на автоматические кампании.

## Причина

В функции `updateStatus` в `offers.service.ts` была логика, которая:
- Для статуса `in_progress`: требовала, чтобы пользователь был получателем предложения
- Для заявок на авто-кампании: инфлюенсер создает заявку (является отправителем), но должен иметь возможность начать работу после принятия рекламодателем

Это создавало конфликт: инфлюенсер не мог начать работу, потому что был отправителем, а не получателем.

## Решение

### Изменения в `backend/src/modules/offers/offers.service.ts`

1. **Добавлено поле `auto_campaign_id` в запрос:**
   ```typescript
   .select('advertiser_id, influencer_id, status, initiated_by, auto_campaign_id')
   ```

2. **Добавлены новые переменные для точной проверки прав:**
   ```typescript
   const isInfluencer = userId === offer.influencer_id;
   const isAdvertiser = userId === offer.advertiser_id;
   const isAutoCampaignApplication = !!offer.auto_campaign_id;
   ```

3. **Обновлена логика для статуса `in_progress`:**
   - Для заявок на авто-кампании: только инфлюенсер может начать работу
   - Для обычных предложений: только получатель может начать работу

4. **Обновлена логика для статуса `terminated`:**
   - Обе стороны могут расторгнуть сотрудничество

5. **Добавлено подробное логирование для отладки**

## Результат

- ✅ Инфлюенсеры могут начать работу по заявкам на авто-кампании после принятия
- ✅ Обе стороны могут расторгнуть сотрудничество
- ✅ Сохранена корректная логика прав доступа для обычных предложений
- ✅ Улучшено логирование для будущей диагностики

## Тестирование

Проверьте следующие сценарии:

1. **Заявка на авто-кампанию:**
   - Инфлюенсер подает заявку на кампанию
   - Рекламодатель принимает заявку
   - Инфлюенсер нажимает "Начать работу" ✅ (должно работать)
   - Любая сторона нажимает "Расторгнуть сотрудничество" ✅ (должно работать)

2. **Обычное предложение:**
   - Рекламодатель отправляет предложение инфлюенсеру
   - Инфлюенсер принимает
   - Инфлюенсер нажимает "Начать работу" ✅ (получатель)
   - Любая сторона может расторгнуть сотрудничество ✅

## Примечания

- Backend использует Service Role Key для полного доступа к Supabase
- Все изменения совместимы с существующей структурой БД
- Не требуются миграции базы данных
